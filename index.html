<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Bayesian Hierarchical Modeling of Power Laws using brms • isdbayes</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Bayesian Hierarchical Modeling of Power Laws using brms">
<meta name="description" content="Estimates the exponent of a power law from one or more samples using Generalized (non)-linear mixed models in brms. The package adds a doubly-truncated Pareto family to brms. It will also simulate data from the doubly-truncated Pareto and and generate plots of posterior fits to data. Most other built-in features of brms, such as conditional_effects() and posterior sampoing will also work.">
<meta property="og:description" content="Estimates the exponent of a power law from one or more samples using Generalized (non)-linear mixed models in brms. The package adds a doubly-truncated Pareto family to brms. It will also simulate data from the doubly-truncated Pareto and and generate plots of posterior fits to data. Most other built-in features of brms, such as conditional_effects() and posterior sampoing will also work.">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">isdbayes</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header"><h1 id="isdbayes-bayesian-hierarchical-modeling-of-size-spectra">isdbayes: Bayesian hierarchical modeling of size spectra<a class="anchor" aria-label="anchor" href="#isdbayes-bayesian-hierarchical-modeling-of-size-spectra"></a>
</h1></div>
<p>Jeff Wesner</p>
</div>
<div class="section level1">
<h1 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h1>
<p>This package allows the estimation of power law exponents using the truncated (upper and lower) Pareto distribution (Wesner et al. 2024). Specifically, it allows users to fit Bayesian (non)-linear hierarchical models with a truncated Pareto likelihood using <code>brms</code> (Bürkner 2017). The motivation for the package was to estimate power law exponents of ecological size spectra using individual-level body size data in a generalized mixed model framework. The likelihood for the truncated Pareto used here was described in (Edwards et al. 2020). This package translates that likelihood into <code>brms</code>.</p>
</div>
<div class="section level1">
<h1 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h1>
<p>This package requires installation of <code>brms</code> and <code>rstan</code>, which itself requires installation of a C++ toolchain.</p>
<ol style="list-style-type: decimal">
<li><p>Go to <a href="https://mc-stan.org/users/interfaces/rstan.html" class="external-link uri">https://mc-stan.org/users/interfaces/rstan.html</a> and follow the instructions to install <code>rstan</code> and configure the C++ toolchain.</p></li>
<li><p>Install the latest version of <code>brms</code> with install.packages(“brms”).</p></li>
<li><p>Install <code>isdbayes</code> from github using <code>devtools</code>:</p></li>
</ol>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># requires an installation of devtools</span></span>
<span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"jswesner/isdbayes"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level1">
<h1 id="examples">Examples<a class="anchor" aria-label="anchor" href="#examples"></a>
</h1>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># load these packages</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://here.r-lib.org/" class="external-link">here</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mjskay.github.io/tidybayes/" class="external-link">tidybayes</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/paul-buerkner/brms" class="external-link">brms</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jswesner.github.io/isdbayes/">isdbayes</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="fit-individual-samples">Fit individual samples<a class="anchor" aria-label="anchor" href="#fit-individual-samples"></a>
</h2>
<p>First, simulate some power law data using <code><a href="reference/rparetocounts.html">rparetocounts()</a></code>. The code below simulates 300 body sizes from a power law with exponent lambda = -1.2, xmin = 1, and xmax = 1000.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># simulate data</span></span>
<span></span>
<span><span class="va">dat</span> <span class="op">=</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="reference/rparetocounts.html">rparetocounts</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">300</span>,  lambda <span class="op">=</span> <span class="op">-</span><span class="fl">1.2</span>,  xmin <span class="op">=</span> <span class="fl">1</span>, xmax <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,</span>
<span>         xmax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,</span>
<span>         counts <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>The code above simulates data from a doubly-truncated Pareto and then estimates xmin and xmax. It also adds a column for <em>counts.</em> If the data all represent unique individual masses, then this column takes a value of 1 for every body size. If the data have repeated sizes, then this column can take an integer or double of the counts or densities of those sizes. For example, data that are x = {1.9, 1.9, 1.8, 2.8, 2.8} could either be analyzed with each body size assumed to be unique where counts = {1, 1, 1, 1, 1} or it could be analyzed as x = {1.9, 1.8, 2.8} and counts = {2, 1, 2}. The latter is a common format when there is a density estimate associated with counts or a sampling effort.</p>
<p>Next estimate the power law exponent using <code>brms</code>. The model below (<code>fit1</code>) is an intercept only model, where x are the body sizes and counts, xmin, and xmax are included in <code>vreal()</code>. The use of <code>vreal</code> has nothing to do with the model per se. It is simply required wording from <code>brms</code> when including custom families. Similarly, <code>stanvars</code> is required wording that contains the custom likelihood parameters. As long as <code>isdbayes</code> is loaded, then <code>stanvars = stanvars</code> will work. It will stay the same regardless of changes to the model structure (like new predictors or varying intercepts).</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">fit1</span> <span class="op">=</span> <span class="fu"><a href="https://paulbuerkner.com/brms/reference/brm.html" class="external-link">brm</a></span><span class="op">(</span><span class="va">x</span> <span class="op">|</span> <span class="fu">vreal</span><span class="op">(</span><span class="va">counts</span>, <span class="va">xmin</span>, <span class="va">xmax</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, </span>
<span>          data <span class="op">=</span> <span class="va">dat</span>,</span>
<span>          stanvars <span class="op">=</span> <span class="va">stanvars</span>,    <span class="co"># required for truncated Pareto</span></span>
<span>          family <span class="op">=</span> <span class="fu"><a href="reference/paretocounts.html">paretocounts</a></span><span class="op">(</span><span class="op">)</span>,<span class="co"># required for truncated Pareto</span></span>
<span>          chains <span class="op">=</span> <span class="fl">1</span>, iter <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span></code></pre></div>
<p>This example fits an intercept-only model to estimate the power-law exponent. For more complex examples with fixed and hierarchical predictors, see below.</p>
</div>
<div class="section level2">
<h2 id="simulate-multiple-size-distributions">Simulate multiple size distributions<a class="anchor" aria-label="anchor" href="#simulate-multiple-size-distributions"></a>
</h2>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">x1</span> <span class="op">=</span> <span class="fu"><a href="reference/rparetocounts.html">rparetocounts</a></span><span class="op">(</span>lambda <span class="op">=</span> <span class="op">-</span><span class="fl">1.8</span><span class="op">)</span> <span class="co"># `lambda` is required wording from brms. in this case it means the lambda exponent of the ISD</span></span>
<span><span class="va">x2</span> <span class="op">=</span> <span class="fu"><a href="reference/rparetocounts.html">rparetocounts</a></span><span class="op">(</span>lambda <span class="op">=</span> <span class="op">-</span><span class="fl">1.5</span><span class="op">)</span></span>
<span><span class="va">x3</span> <span class="op">=</span> <span class="fu"><a href="reference/rparetocounts.html">rparetocounts</a></span><span class="op">(</span>lambda <span class="op">=</span> <span class="op">-</span><span class="fl">1.2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">isd_data</span> <span class="op">=</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>x1 <span class="op">=</span> <span class="va">x1</span>,</span>
<span>                  x2 <span class="op">=</span> <span class="va">x2</span>,</span>
<span>                  x3 <span class="op">=</span> <span class="va">x3</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html" class="external-link">everything</a></span><span class="op">(</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="st">"group"</span>, values_to <span class="op">=</span> <span class="st">"x"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">group</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,</span>
<span>         xmax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">group</span>, <span class="va">x</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">add_count</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"counts"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="fit-multiple-size-distributions-with-a-fixed-factor">Fit multiple size distributions with a fixed factor<a class="anchor" aria-label="anchor" href="#fit-multiple-size-distributions-with-a-fixed-factor"></a>
</h2>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit2</span> <span class="op">=</span> <span class="fu"><a href="https://paulbuerkner.com/brms/reference/brm.html" class="external-link">brm</a></span><span class="op">(</span><span class="va">x</span> <span class="op">|</span> <span class="fu">vreal</span><span class="op">(</span><span class="va">counts</span>, <span class="va">xmin</span>, <span class="va">xmax</span><span class="op">)</span> <span class="op">~</span> <span class="va">group</span>, </span>
<span>           data <span class="op">=</span> <span class="va">isd_data</span>,</span>
<span>           stanvars <span class="op">=</span> <span class="va">stanvars</span>,</span>
<span>           family <span class="op">=</span> <span class="fu"><a href="reference/paretocounts.html">paretocounts</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>           chains <span class="op">=</span> <span class="fl">1</span>, iter <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="plot-group-posteriors">Plot group posteriors<a class="anchor" aria-label="anchor" href="#plot-group-posteriors"></a>
</h2>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">posts_group</span> <span class="op">=</span> <span class="va">fit2</span><span class="op">$</span><span class="va">data</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="va">group</span>, <span class="va">xmin</span>, <span class="va">xmax</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>counts <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://mjskay.github.io/tidybayes/reference/add_predicted_draws.html" class="external-link">add_epred_draws</a></span><span class="op">(</span><span class="va">fit2</span>, re_formula <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">posts_group</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">group</span>, y <span class="op">=</span> <span class="va">.epred</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://mjskay.github.io/ggdist/reference/stat_halfeye.html" class="external-link">stat_halfeye</a></span><span class="op">(</span>scale <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1.8</span>, <span class="op">-</span><span class="fl">1.5</span>, <span class="op">-</span><span class="fl">1.2</span><span class="op">)</span><span class="op">)</span> <span class="co"># known lambdas</span></span></code></pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-9-1.png"><!-- --></p>
</div>
<div class="section level2">
<h2 id="fit-multiple-size-distributions-with-a-varying-intercept">Fit multiple size distributions with a varying intercept<a class="anchor" aria-label="anchor" href="#fit-multiple-size-distributions-with-a-varying-intercept"></a>
</h2>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit3</span> <span class="op">=</span> <span class="fu"><a href="https://paulbuerkner.com/brms/reference/brm.html" class="external-link">brm</a></span><span class="op">(</span><span class="va">x</span> <span class="op">|</span> <span class="fu">vreal</span><span class="op">(</span><span class="va">counts</span>, <span class="va">xmin</span>, <span class="va">xmax</span><span class="op">)</span> <span class="op">~</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">group</span><span class="op">)</span>, </span>
<span>           data <span class="op">=</span> <span class="va">isd_data</span>,</span>
<span>           stanvars <span class="op">=</span> <span class="va">stanvars</span>,</span>
<span>           family <span class="op">=</span> <span class="fu"><a href="reference/paretocounts.html">paretocounts</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>           chains <span class="op">=</span> <span class="fl">1</span>, iter <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="plot-varying-intercepts">Plot varying intercepts<a class="anchor" aria-label="anchor" href="#plot-varying-intercepts"></a>
</h2>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">posts_varint</span> <span class="op">=</span> <span class="va">fit3</span><span class="op">$</span><span class="va">data</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="va">group</span>, <span class="va">xmin</span>, <span class="va">xmax</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>counts <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://mjskay.github.io/tidybayes/reference/add_predicted_draws.html" class="external-link">add_epred_draws</a></span><span class="op">(</span><span class="va">fit3</span>, re_formula <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">posts_varint</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">group</span>, y <span class="op">=</span> <span class="va">.epred</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://mjskay.github.io/ggdist/reference/stat_halfeye.html" class="external-link">stat_halfeye</a></span><span class="op">(</span>scale <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1.8</span>, <span class="op">-</span><span class="fl">1.5</span>, <span class="op">-</span><span class="fl">1.2</span><span class="op">)</span><span class="op">)</span> <span class="co"># known lambdas</span></span></code></pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-11-1.png"><!-- --></p>
</div>
<div class="section level2">
<h2 id="posterior-predictive-checks">Posterior predictive checks<a class="anchor" aria-label="anchor" href="#posterior-predictive-checks"></a>
</h2>
<p>After the model is fit, you can use built-in functions in brms to perform model checking.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/pp_check.html" class="external-link">pp_check</a></span><span class="op">(</span><span class="va">fit2</span><span class="op">)</span></span>
<span><span class="co">#&gt; Using 10 posterior draws for ppc type 'dens_overlay' by default.</span></span></code></pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-12-1.png"><!-- --></p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/pp_check.html" class="external-link">pp_check</a></span><span class="op">(</span><span class="va">fit2</span>, type <span class="op">=</span> <span class="st">"dens_overlay_grouped"</span>, group <span class="op">=</span> <span class="st">"group"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_log10</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Using 10 posterior draws for ppc type 'dens_overlay_grouped' by default.</span></span>
<span><span class="co">#&gt; Warning in transformation$transform(x): NaNs produced</span></span>
<span><span class="co">#&gt; Warning in transformation$transform(x): NaNs produced</span></span>
<span><span class="co">#&gt; Warning: Removed 6 rows containing missing values or values outside the scale range</span></span>
<span><span class="co">#&gt; (`geom_segment()`).</span></span></code></pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-12-2.png"><!-- --></p>
</div>
<div class="section level2">
<h2 id="visualize-isd">Visualize ISD<a class="anchor" aria-label="anchor" href="#visualize-isd"></a>
</h2>
<p>This code extracts the cumulative probabilities using <code><a href="reference/pparetocounts.html">pparetocounts()</a></code> and the plots them over raw data. Note that the raw data probabilities are simply estimates for visualization purposes. These plots are typical in studies of the ISD and are visually similar to plots of log-abundance vs log-size, making them more familiar to readers (maybe).</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1) sort raw data</span></span>
<span><span class="va">d</span> <span class="op">=</span> <span class="va">fit1</span><span class="op">$</span><span class="va">data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">x</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>order <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>         y_raw_prob <span class="op">=</span> <span class="va">order</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">order</span><span class="op">)</span><span class="op">)</span> <span class="co"># convert to 0-1 scale</span></span>
<span></span>
<span><span class="co"># 2) data grid to sample over</span></span>
<span><span class="va">data_grid</span> <span class="op">=</span> <span class="va">d</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="va">xmin</span>, <span class="va">xmax</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/expand_grid.html" class="external-link">expand_grid</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">2</span><span class="op">^</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log2</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log2</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>, length.out <span class="op">=</span> <span class="fl">30</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># sequence is log 2 to ensure equal logarithmic spacing</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>counts <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="co"># This is a default. Even if counts are &gt;1 inthe raw data, make them = 1 here.</span></span>
<span></span>
<span><span class="co"># 3) extract posteriors</span></span>
<span><span class="va">isd_posts</span> <span class="op">=</span> <span class="va">data_grid</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tidybayes</span><span class="fu">::</span><span class="fu"><a href="https://mjskay.github.io/tidybayes/reference/add_predicted_draws.html" class="external-link">add_epred_draws</a></span><span class="op">(</span><span class="va">fit1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 4) get cumulative probabilities from posteriors</span></span>
<span><span class="va">isd_lines</span> <span class="op">=</span> <span class="va">isd_posts</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html" class="external-link">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>y_prob <span class="op">=</span> <span class="fu"><a href="reference/pparetocounts.html">pparetocounts</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, xmin <span class="op">=</span> <span class="va">xmin</span> ,xmax <span class="op">=</span> <span class="va">xmax</span>, lambda <span class="op">=</span> <span class="va">.epred</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 5) plot raw vs posterior samples</span></span>
<span><span class="va">isd_lines</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">.draw</span> <span class="op">&lt;=</span> <span class="fl">100</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># limits to the first 100 draws. Change as needed or use a summary to plot instead of individual lines</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y_prob</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>group <span class="op">=</span> <span class="va">.draw</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">d</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">y_raw_prob</span><span class="op">)</span>,</span>
<span>             shape <span class="op">=</span> <span class="fl">21</span>, fill <span class="op">=</span> <span class="st">"white"</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"P(X &gt;= x)"</span><span class="op">)</span></span></code></pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-13-1.png"><!-- --></p>
</div>
<div class="section level2">
<h2 id="addressing-undersampling">Addressing Undersampling<a class="anchor" aria-label="anchor" href="#addressing-undersampling"></a>
</h2>
<p>In field collections of body sizes, small organisms are commonly undersampled. This contradicts that assumption of an exponential decline in frequency as body size increases and can lead to dramatically poor estimates of lambda (Clauset, Shalizi, and Newman 2009). For this reason, we strongly recommend checking for and removing undersampled small sizes. We show this below with simulated data</p>
<p><em>Simulate data to show undersampling</em></p>
<ol style="list-style-type: decimal">
<li>Generate unbiased data using <code><a href="reference/rparetocounts.html">rparetocounts()</a></code>
</li>
</ol>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">4222</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 1) sample 1000 body sizes</span></span>
<span><span class="va">unbiased_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="reference/rparetocounts.html">rparetocounts</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">2000</span>, lambda <span class="op">=</span> <span class="op">-</span><span class="fl">1.5</span><span class="op">)</span>,</span>
<span>                            data <span class="op">=</span> <span class="st">"unbiased data"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>,</span>
<span>         counts <span class="op">=</span> <span class="fl">1</span>,</span>
<span>         xmin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,</span>
<span>         xmax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>Generate biased data by assigning low probabilities to small sizes and then re-sampling, weighted by the probability.</li>
</ol>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">4222</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2) create undersampling by resampling weighted by prob of occcurence</span></span>
<span><span class="va">biased_data</span> <span class="op">=</span> <span class="va">unbiased_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>prob <span class="op">=</span> <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paulbuerkner.com/brms/reference/inv_logit_scaled.html" class="external-link">inv_logit_scaled</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">20</span>, <span class="fl">10</span>, length.out <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co">#this assigns low probabilities to the small stuff b/c sizes are arranged by size first in step 1</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample_n.html" class="external-link">sample_n</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">2000</span>, weight <span class="op">=</span> <span class="va">prob</span>, replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>  <span class="co"># resample with small things less probable</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="st">"biased data"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>,</span>
<span>         counts <span class="op">=</span> <span class="fl">1</span>,</span>
<span>         xmin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,</span>
<span>         xmax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>Find and remove biased sizes</li>
</ol>
<p>How do we know if body sizes are undersampled? One option, which we recommend, is to use the <code>estimate_xmin()</code> function from the <code>poweRlaw</code> package (Gillespie 2015). It first fits the data to a power law (unbounded, but that’s OK here). Then it uses Kolmogorov-Smirnoff sampling to find the minimum size above which the data follow a power law.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/csgillespie/poweRlaw" class="external-link">poweRlaw</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># fit a continuous power law using the poweRlaw package model (note it is not a truncated Pareto, but that is OK for these purposes)</span></span>
<span><span class="va">temp_mod</span> <span class="op">=</span> <span class="va">conpl</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">biased_data</span><span class="op">$</span><span class="va">x</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># use estimate_xmin to determine the minimum size for which the data still follow a power law</span></span>
<span><span class="va">xmin_est</span> <span class="op">=</span> <span class="fu">estimate_xmin</span><span class="op">(</span><span class="va">temp_mod</span><span class="op">)</span><span class="op">$</span><span class="va">xmin</span></span>
<span></span>
<span><span class="co"># remove sizes smaller than xmin</span></span>
<span><span class="va">biased_data_fixed</span> <span class="op">=</span> <span class="va">biased_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">x</span> <span class="op">&gt;=</span> <span class="va">xmin_est</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="co"># don't forget to re-set xmin...very important!</span></span></code></pre></div>
<p><code>xmin_est</code> contains the minimum value, above which the data follow a power law. In this case, it is 26.7. We removed all sizes below that.</p>
<p>The plot below shows these three data sets. Note the strong undersampling in b) as shown by the small bar on the left. In c), these values have been trimmed off and there is not white space below x = 26.7. Note that the trimming can be quite large despite the relatively small <code>xmin_est</code> value. In this case, it removed ~5% of the data, but it can sometimes remove much more (such as 25 or 50%). That is usually not a problem as long as the remaining data has enough individuals to fit reliably, usually 300 or so.</p>
<p><img src="README_files/figure-gfm/unnamed-chunk-17-1.png"><!-- --></p>
<p><em>Undersampling effects on lambda</em></p>
<p>Now we estimate lambda from the three data sets and compare the fits.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">fit_unbiased</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">fit1</span>, newdata <span class="op">=</span> <span class="va">unbiased_data</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 1).</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: Gradient evaluation took 0.001362 seconds</span></span>
<span><span class="co">#&gt; Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 13.62 seconds.</span></span>
<span><span class="co">#&gt; Chain 1: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: Iteration:   1 / 1000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 100 / 1000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 200 / 1000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 300 / 1000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 400 / 1000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 500 / 1000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 501 / 1000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 600 / 1000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 700 / 1000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 800 / 1000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 900 / 1000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1000 / 1000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1:  Elapsed Time: 2.462 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 1:                2.304 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1:                4.766 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 1:</span></span>
<span><span class="va">fit_biased</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">fit1</span>, newdata <span class="op">=</span> <span class="va">biased_data</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 1).</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: Gradient evaluation took 0.000856 seconds</span></span>
<span><span class="co">#&gt; Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 8.56 seconds.</span></span>
<span><span class="co">#&gt; Chain 1: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: Iteration:   1 / 1000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 100 / 1000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 200 / 1000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 300 / 1000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 400 / 1000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 500 / 1000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 501 / 1000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 600 / 1000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 700 / 1000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 800 / 1000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 900 / 1000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1000 / 1000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1:  Elapsed Time: 2.211 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 1:                2.681 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1:                4.892 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 1:</span></span>
<span><span class="va">fit_trimmed</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">fit1</span>, newdata <span class="op">=</span> <span class="va">biased_data_fixed</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 1).</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: Gradient evaluation took 0.001054 seconds</span></span>
<span><span class="co">#&gt; Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 10.54 seconds.</span></span>
<span><span class="co">#&gt; Chain 1: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: Iteration:   1 / 1000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 100 / 1000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 200 / 1000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 300 / 1000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 400 / 1000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 500 / 1000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 501 / 1000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 600 / 1000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 700 / 1000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 800 / 1000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 900 / 1000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1000 / 1000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1:  Elapsed Time: 1.171 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 1:                1.722 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1:                2.893 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 1:</span></span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="co">#&gt; # A tibble: 3 × 7</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a><span class="co">#&gt;   data            n Target_lambda Estimate Est.Error `l-95% CI` `u-95% CI`</span></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt;       &lt;int&gt;         &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;</span></span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a><span class="co">#&gt; 1 a) Unbiased  2000          -1.5    -1.49    0.0151      -1.52      -1.46</span></span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a><span class="co">#&gt; 2 b) Biased    2000          -1.5    -1.15    0.0136      -1.18      -1.13</span></span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a><span class="co">#&gt; 3 c) Trimmed   1090          -1.5    -1.54    0.0322      -1.61      -1.48</span></span></code></pre></div>
<p>This shows the target lambda value along with the posterior median <code>Estimate</code>, error, and upper an lower credible intervals. As expected, the model with unbiased data performs well, recapturing the known lambda. The model with biased data performs poorly, with the credible intervals nowhere close to the true lambda. Note the drastic mis-fit that occurs even though the biased samples occur only in the very smallest individuals (i.e., 26.7/1000 = 2.5%). After trimming those individuals out, the model again recaptures lambda well.</p>
<p><em>What about multiple samples?</em></p>
<p>The trimming procedure is sample-specific, not global. So if you have multiple samples, then you’ll need to run the <code>estimate_xmin</code> procedure on each sample, trim with a unique <code>xmin_est</code>, and recalculate xmin for each sample.</p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-burkner2017brms" class="csl-entry">
Bürkner, Paul-Christian. 2017. “Brms: An r Package for Bayesian Multilevel Models Using Stan.” <em>Journal of Statistical Software</em> 80: 1–28.
</div>
<div id="ref-clauset2009power" class="csl-entry">
Clauset, Aaron, Cosma Rohilla Shalizi, and Mark EJ Newman. 2009. “Power-Law Distributions in Empirical Data.” <em>SIAM Review</em> 51 (4): 661–703.
</div>
<div id="ref-edwards2020" class="csl-entry">
Edwards, Am, Jpw Robinson, Jl Blanchard, Jk Baum, and Mj Plank. 2020. “Accounting for the Bin Structure of Data Removes Bias When Fitting Size Spectra.” <em>Marine Ecology Progress Series</em> 636 (February): 19–33. <a href="https://doi.org/10.3354/meps13230" class="external-link uri">https://doi.org/10.3354/meps13230</a>.
</div>
<div id="ref-Gillespie_powerlaw" class="csl-entry">
Gillespie, Colin S. 2015. “Fitting Heavy Tailed Distributions: The <span class="nocase">poweRlaw</span> Package.” <em>Journal of Statistical Software</em> 64 (2): 1–16. <a href="https://doi.org/10.18637/jss.v064.i02" class="external-link uri">https://doi.org/10.18637/jss.v064.i02</a>.
</div>
<div id="ref-wesner2024bayesian" class="csl-entry">
Wesner, Jeff S, Justin PF Pomeranz, James R Junker, and Vojsava Gjoni. 2024. “Bayesian Hierarchical Modelling of Size Spectra.” <em>Methods in Ecology and Evolution</em> 15 (5): 856–67.
</div>
</div>
</div>
</div>

  </main><aside class="col-md-3"><div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing isdbayes</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Jeff Wesner <br><small class="roles"> Author, maintainer </small>   </li>
<li>Justin Pomeranz <br><small class="roles"> Author </small>   </li>
</ul>
</div>



  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jeff Wesner, Justin Pomeranz.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
